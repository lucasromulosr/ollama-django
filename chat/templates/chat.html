<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ollama Chat</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #e0e0e0;
    }

    #chat-container {
      width: 80%;
      height: 75vh;
      margin: 20px auto;
      background: #1e1e1e;
      border-radius: 10px;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.6);
    }

    .message {
      display: flex;
      margin: 10px 0;
    }

    .message .bubble {
      max-width: 70%;
      padding: 12px 18px;
      border-radius: 20px;
      line-height: 1.4em;
      word-wrap: break-word;
    }

    .user-message {
      justify-content: flex-end;
    }

    .user-message .bubble {
      background-color: #0d47a1;
      color: #ffffff;
      border-bottom-right-radius: 0;
    }

    .ai-message {
      justify-content: flex-start;
    }

    .ai-message .bubble {
      background-color: #333;
      color: #e0e0e0;
      border-bottom-left-radius: 0;
    }

    #input-form {
      display: flex;
      justify-content: center;
      width: 100%;
      max-width: 600px;
      margin: 10px;
    }

    #user-input {
      flex: 1;
      padding: 10px;
      border-radius: 10px 0 0 10px;
      border: 1px solid #555;
      background-color: #222;
      color: #f5f5f5;
    }

    #send-button {
      padding: 10px 20px;
      border: none;
      background-color: #1976d2;
      color: white;
      border-radius: 0 10px 10px 0;
      cursor: pointer;
    }

    #send-button:hover {
      background-color: #1565c0;
    }

    #context-clear-button {
      background-color: darkred;
      color: white;
      border: 1px solid white;
      border-radius: 5px;
      text-align: center;
    }

    #context-clear-button:hover {
      background-color: red;
    }

    #context-clear-popup {
      display: none;
      position: fixed;
      justify-content: center;
      top: 50px;
      background-color: #333;
      color: #fff;
      font-size: 16px;
      padding: 16px 32px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    #model-selector {
      width: 250px;
      {#padding: 8px;#}
      {#margin-bottom: 16px;#}
      background-color: #222;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      text-align: center;
    }

    #status-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(4px); /* background blur */
      background-color: rgba(0, 0, 0, 0.3); /* slight dimming */
      z-index: 9998;
    }

    #status-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      z-index: 9999;
      font-size: 1.1em;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
    }

    .popup-text {
      display: block;
      font-size: 16px;
      margin-top: 10px;
    }

    .spinner {
      margin: 0 auto 10px;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  {% csrf_token %}

  <div id="chat-container"></div>

  <form id="input-form">
    <input type="text" id="user-input" name="user_input" placeholder="Type your message..." required autocomplete="off" />
    <button id="send-button" type="submit">Send</button>
  </form>

  <div>
    <button id="context-clear-button" type="button">clear context</button>
    <input type="text" id="model-selector" placeholder="Model name (defaults to llama3)">
  </div>

  <script>
    function getCookie(name) {
      const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith(name + '='))
        ?.split('=')[1];
      return cookieValue;
    }

    // Setup jQuery to include CSRF token in all AJAX requests
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!(/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type))) {
          xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
        }
      }
    });
  </script>
  <script>
    $(document).ready(function () {
      const $chatContainer = $("#chat-container");

      $("#input-form").submit(function (e) {
        e.preventDefault();
        const userInput = $("#user-input").val().trim();
        const modelName = $("#model-selector").val();

        if (!userInput) return;
        $("#user-input").val("");

        addMessage("user", userInput);
        const aiBubble = addMessage("ai", "");

        waitForModelThenChat(modelName, userInput, aiBubble.find(".bubble"));
      });

      function addMessage(role, text) {
        const message = $(`
          <div class="message ${role}-message">
            <div class="bubble">${$("<div>").text(text).html()}</div>
          </div>
        `);
        $chatContainer.append(message);
        $chatContainer.scrollTop($chatContainer[0].scrollHeight);
        return message;
      }

      function waitForModelThenChat(modelName, userInput, aiTextEl) {
        const modelSelectEndpoint = "/ollama/model/select/";
        let popupTimer = setTimeout( () => {
            showStatusPopup("Preparing model. This may take a few seconds...");
        }, 1000);
        $.ajax({
          url: modelSelectEndpoint,
          method: "GET",
          data: { model_name: modelName },
          complete: function (xhr) {
            clearTimeout(popupTimer);
            removeStatusPopup();
            if (xhr.status === 200) {
              streamChat(modelName, userInput, aiTextEl);
            } else if (xhr.status === 503) {
              showStatusPopup("Downloading model. This may take several minutes...");
              const retryAfter = parseInt(xhr.getResponseHeader("Retry-After")) || 5;
              setTimeout(() => {
                waitForModelThenChat(modelName, userInput, aiTextEl)
              }, retryAfter * 1000);
            } else {
              aiTextEl.text("⚠️ Unexpected error in model selection.");
            }
          }
        });
      }

      function streamChat(modelName, userInput, aiTextEl) {
        const chatEndpoint = "/chat/";
        const xhr = new XMLHttpRequest();
        xhr.open("POST", chatEndpoint, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));

        let lastLength = 0;
        xhr.onprogress = function () {
          const chunk = xhr.responseText.substring(lastLength);
          lastLength = xhr.responseText.length;
          aiTextEl.append(document.createTextNode(chunk));
          $chatContainer.scrollTop($chatContainer[0].scrollHeight);
        };

        xhr.onload = function () {
          if (xhr.status !== 200) {
            aiTextEl.text("⚠️ Error: " + xhr.status);
          }
        };

        const params = new URLSearchParams();
        params.append("user_input", userInput);
        params.append("model_name", modelName);
        xhr.send(params.toString());
      }

      function showStatusPopup(text) {
        if (!$("#status-popup").length) {
          $("body").append(`
            <div id="status-overlay"></div>
            <div id="status-popup">
              <div class="spinner"></div>
              <span class="popup-text">${text}</span>
            </div>
          `);
        } else {
          $(".popup-text").text(text);
        }
      }

      function removeStatusPopup() {
        $("#status-popup").remove();
        $("#status-overlay").remove();
      }
    });
  </script>
  <script>
    function contextClearPopup(message, isSuccess) {
      if (!$("#context-clear-popup").length) {
        $("body").append(`<div id='context-clear-popup'></div>`);
      }
      const popup = $('#context-clear-popup');
      popup.text(message);
      popup.css('background-color', isSuccess ? '#28a745' : '#dc3545');
      popup.fadeIn(200);

      setTimeout(() => {
        popup.fadeOut(400);
      }, 1000);
    }
    $(document).ready(function () {
      $("#context-clear-button").click(function (e) {
        const contextClearEndpoint = "/chat/context/clear/";
        $.ajax({
          url: contextClearEndpoint,
          type: 'POST',
          success: function (response) {
            contextClearPopup('Context cleared.', true);
          },
          error: function (xhr) {
            contextClearPopup('Error clearing context.', false);
          }
        });
      });
    });
  </script>
</body>
</html>
